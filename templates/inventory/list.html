{% extends "base.html" %}

{% block title %}Inventory - Pharmacy Analytic AI{% endblock %}
{% block page_title %}Inventory Management{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h2 class="text-2xl font-bold text-gray-800">Inventory</h2>
        <p class="text-gray-600 mt-1">Monitor stock levels and manage inventory</p>
    </div>
    <a href="{% url 'inventory-reorder-recommendations' %}" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
        <i class="fas fa-exclamation-triangle mr-2"></i>Reorder Alerts
    </a>
</div>

<!-- Inventory Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Medicine</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Stock</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Min Level</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Max Level</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function loadInventory() {
    try {
        const response = await fetch('/api/inventory/inventory/');
        const data = await response.json();
        renderInventory(data.results || []);
    } catch (error) {
        console.error('Error loading inventory:', error);
    }
}

function renderInventory(inventory) {
    const tbody = document.getElementById('inventory-table-body');
    if (inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No inventory records</td></tr>';
        return;
    }
    
    tbody.innerHTML = inventory.map(item => {
        const needsReorder = item.needs_reorder;
        const stockPercent = item.stock_percentage || 0;
        const statusClass = needsReorder ? 'bg-red-100 text-red-800' : stockPercent < 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
        const statusText = needsReorder ? 'Low Stock' : stockPercent < 50 ? 'Medium' : 'Good';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${item.medicine_name || 'N/A'}</div>
                    <div class="text-sm text-gray-500">${item.medicine_sku || ''}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${needsReorder ? 'text-red-600 font-semibold' : 'text-gray-900'}">
                    ${item.current_stock || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.min_stock_level || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.max_stock_level || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded ${statusClass}">${statusText}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="updateStock(${item.id})" class="text-blue-600 hover:text-blue-900">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateStock(id) {
    const quantity = prompt('Enter new stock quantity:');
    if (!quantity || isNaN(quantity)) return;
    
    fetch(`/api/inventory/inventory/${id}/update_stock/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ quantity: parseInt(quantity), operation: 'set' })
    })
    .then(() => loadInventory())
    .catch(error => console.error('Error updating stock:', error));
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

loadInventory();
</script>
{% endblock %}
