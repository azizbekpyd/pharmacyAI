{% extends "base.html" %}

{% block title %}Add Medicine - Pharmacy Analytic AI{% endblock %}
{% block page_title %}Add Medicine{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="mb-6 flex items-start justify-between">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Create New Medicine</h2>
            <p class="mt-1 text-sm text-gray-600">Enter medicine details for your pharmacy catalog.</p>
        </div>
        <a href="{% url 'medicines-list' %}" class="inline-flex items-center rounded-lg border border-gray-300 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
            <i class="fas fa-arrow-left mr-2"></i>Back to List
        </a>
    </div>

    <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <form id="medicine-create-form" class="p-6 space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Medicine Name</label>
                    <input id="name" name="name" type="text" required
                           class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g. Paracetamol 500mg">
                </div>
                <div>
                    <label for="sku" class="block text-sm font-medium text-gray-700 mb-1">SKU</label>
                    <input id="sku" name="sku" type="text" required
                           class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g. MED011">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="category" name="category"
                            class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500">
                        <option value="">Uncategorized</option>
                    </select>
                </div>
                <div>
                    <label for="expiry_date" class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                    <input id="expiry_date" name="expiry_date" type="date"
                           class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="unit_price" class="block text-sm font-medium text-gray-700 mb-1">Unit Price (UZS)</label>
                    <input id="unit_price" name="unit_price" type="number" min="0.01" step="0.01" required
                           class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g. 25000">
                    <p class="mt-1 text-xs text-gray-500">Enter numeric value only; displayed as UZS in the UI.</p>
                </div>
                <div>
                    <label for="stock" class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                    <input id="stock" name="stock" type="number" min="0" step="1" value="0"
                           class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g. 100">
                    <p class="mt-1 text-xs text-gray-500">Current quantity available in inventory.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="flex items-end">
                    <div class="w-full rounded-lg bg-gray-50 border border-gray-200 px-3 py-2.5">
                        <p class="text-xs text-gray-500">Preview</p>
                        <p id="price-preview" class="text-sm font-semibold text-gray-900">0.00 UZS</p>
                    </div>
                </div>
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="description" name="description" rows="4"
                          class="w-full rounded-lg border border-gray-300 px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
                          placeholder="Optional notes about this medicine"></textarea>
            </div>

            <div id="form-message" class="hidden rounded-lg px-4 py-3 text-sm"></div>

            <div class="flex items-center justify-end gap-3 pt-2">
                <a href="{% url 'medicines-list' %}" class="rounded-lg border border-gray-300 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Cancel</a>
                <button type="submit" class="inline-flex items-center rounded-lg bg-blue-600 px-5 py-2 text-sm font-medium text-white hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i>Create Medicine
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatUZS(amount) {
    return new Intl.NumberFormat('uz-UZ', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(Number(amount || 0)) + ' UZS';
}

function setMessage(text, type) {
    const box = document.getElementById('form-message');
    box.className = 'rounded-lg px-4 py-3 text-sm';
    if (type === 'error') {
        box.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
    } else {
        box.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
    }
    box.textContent = text;
    box.classList.remove('hidden');
}

async function loadCategories() {
    try {
        const response = await fetch('/api/medicines/categories/');
        const data = await response.json();
        const select = document.getElementById('category');
        (data.results || []).forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });
    } catch (error) {
        setMessage('Could not load categories.', 'error');
    }
}

document.getElementById('unit_price').addEventListener('input', function() {
    document.getElementById('price-preview').textContent = formatUZS(this.value);
});

document.getElementById('medicine-create-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const stockRaw = form.stock.value;
    const stockValue = stockRaw === '' ? 0 : Number(stockRaw);

    if (!Number.isInteger(stockValue) || stockValue < 0) {
        setMessage('Stock must be a non-negative integer.', 'error');
        return;
    }

    const payload = {
        name: form.name.value.trim(),
        sku: form.sku.value.trim(),
        unit_price: form.unit_price.value,
        expiry_date: form.expiry_date.value || null,
        description: form.description.value.trim() || null,
        initial_stock: stockValue
    };

    const categoryValue = form.category.value;
    if (categoryValue) {
        payload.category_id = categoryValue;
    }

    try {
        const response = await fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        const responseData = await response.json();

        if (response.ok) {
            setMessage('Medicine created successfully.', 'success');
            setTimeout(() => {
                window.location.href = "{% url 'medicines-list' %}";
            }, 700);
            return;
        }

        const firstError = Object.values(responseData)[0];
        const errorMessage = Array.isArray(firstError) ? firstError[0] : 'Failed to create medicine.';
        setMessage(errorMessage, 'error');
    } catch (error) {
        setMessage('Network error while creating medicine.', 'error');
    }
});

loadCategories();
</script>
{% endblock %}
